---
# tasks file for calico-install

- name: Pull calico-{{ calico_version }} docker image 
  docker_image:
    source: pull
    name: "quay.io/calico/node:{{ calico_version }}"

- name: Run calico-{{ calico_version }} docker image
  docker_container:
    name: "calico-{{ calico_version }}"
    state: started
    network_mode: host
    privileged: yes
    image: "quay.io/calico/node:{{ calico_version }}"
    #auto_remove: true
    volumes:
      - /var/log/calico:/var/log/calico
      - /run/docker/plugins:/run/docker/plugins
      - /lib/modules:/lib/modules
      - /var/run/calico:/var/run/calico
      - /var/lib/calico:/var/lib/calico
    env:
      IP: "{{ hostvars[inventory_hostname]['ansible_enp0s8']['ipv4']['address'] }}"
      CALICO_NETWORKING_BACKEND: "{{ calico_backend }}"
      NO_DEFAULT_POOLS: "true"
      CALICO_LIBNETWORK_ENABLED: "false"
      ETCD_ENDPOINTS: "http://{{ etcd_ip }}:2379"


- name: Download calicoctl
  get_url:
    url: https://github.com/projectcalico/calicoctl/releases/download/v3.16.0/calicoctl
    dst: /usr/local/bin/
    mode: '0755'
    owner: root
    group: root 

